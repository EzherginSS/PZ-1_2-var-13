# Практическая работа 1.2 - Написание сложных аналитических SQL-запросов
## Вариант 13

Выполнил: Ежергин Святослав Сергеевич

---

## Содержание

1. Общая информация
2. Структура проекта
3. Архитектура базы данных
4. Выполнение заданий
5. Проверка качества данных
6. Результаты выполнения
7. Файлы проекта

---

## 1. Общая информация

**Цель работы:** освоить принципы проектирования баз данных, создания структуры таблиц и загрузки данных в PostgreSQL, а также написание сложных аналитических SQL-запросов.

**Используемое ПО:**
- PostgreSQL 16+
- DBeaver (SQL-клиент)
- Конфигурация devops_dba_25.ova
- База данных Superstore

**Вариант заданий:** 13
1. Создать представление по клиентам
2. Определить продажи по способам доставки
3. Рассчитать среднюю прибыль по городам

---

## 2. Структура проекта

практическая_работа_1.2_вариант13/
- sql/
  - ddl_prototype.sql           # DDL-скрипт прототипа БД
  - create_tables.sql           # Создание всех таблиц
  - variant_13_tasks.sql        # Решение задач варианта 13
  - data_quality.sql            # Проверки качества данных
- results/
  - variant_13_task1_customers.csv        # Результаты задания 1
  - variant_13_task2_customers.csv        # Результаты задания 2
  - variant_13_task3_customers.csv        # Результаты задания 3
- diagrams/
  - Концептуальная_модель.png   # Концептуальная модель данных
  - Логическая_модель.png       # Логическая модель данных
  - Физическая_модель.png       # Физическая модель данных
- README.md                     # Документация проекта

---

## 3. Архитектура базы данных

### 3.1. Многослойная архитектура

База данных реализована по принципу многослойной архитектуры:

- **STG (Staging) слой** - для хранения сырых, необработанных данных
- **DW (Data Warehouse) слой** - для хранения очищенных, структурированных данных

### 3.2. Схемы базы данных

- **Схема `stg`** - содержит таблицы с исходными данными
- **Схема `dw`** - содержит витрину данных в формате звездообразной схемы

### 3.3. STG слой (3 таблицы)

1. **stg.orders** - таблица заказов в исходном формате (21 атрибут)
2. **stg.people** - таблица менеджеров по регионам
3. **stg.returns** - таблица возвратов товаров

### 3.4. DW слой (звездообразная схема)

**Таблицы измерений (Dimensions):**
1. **dw.shipping_dim** - справочник способов доставки
2. **dw.customer_dim** - справочник клиентов
3. **dw.geo_dim** - справочник географических локаций
4. **dw.product_dim** - справочник продуктов
5. **dw.calendar_dim** - справочник дат (календарь)

**Таблица фактов (Facts):**
1. **dw.sales_fact** - таблица фактов продаж

**Представления (Views):**
1. **dw.customers_summary** - агрегированная информация о клиентах
2. **dw.v_sales_by_category** - анализ продаж по категориям
3. **dw.v_sales_by_geography** - географический анализ продаж

### 3.5. Связи между таблицами

Реализована классическая звездообразная схема (star schema):
- Таблица `dw.sales_fact` находится в центре схемы
- Все таблицы измерений связаны с таблицей фактов через внешние ключи
- Связи "один-ко-многим" от измерений к фактам

### 3.6. Типы данных и ограничения

**Основные типы данных:**
- Для финансовых показателей (sales, profit) использован тип NUMERIC с указанной точностью
- Текстовые поля используют VARCHAR с длинами, соответствующими исходным данным
- Суррогатные ключи используют тип SERIAL для автоматической генерации

**Ограничения целостности:**
- Первичные ключи (PRIMARY KEY) на всех таблицах измерений и фактов
- Внешние ключи (FOREIGN KEY) для обеспечения ссылочной целостности
- Уникальные ограничения (UNIQUE) на бизнес-ключи
- Проверочные ограничения для контроля допустимых значений

---

## 4. Выполнение заданий

### 4.1. Задание 1: Создать представление по клиентам

**Цель:** создать агрегированное представление с полной информацией о клиентах.

**SQL-код:**
```sql
CREATE OR REPLACE VIEW dw.customers_summary AS
SELECT 
    cd.cust_id,
    cd.customer_id,
    cd.customer_name,
    g.city,
    g.state,
    g.country,
    COUNT(DISTINCT sf.order_id) AS total_orders,
    SUM(sf.sales) AS total_sales,
    SUM(sf.profit) AS total_profit
FROM dw.customer_dim cd
LEFT JOIN dw.sales_fact sf ON cd.cust_id = sf.cust_id
LEFT JOIN dw.geo_dim g ON sf.geo_id = g.geo_id
GROUP BY 
    cd.cust_id,
    cd.customer_id,
    cd.customer_name,
    g.city,
    g.state,
    g.country;
```
**Логика работы:**
Представление объединяет данные из трех таблиц: измерение клиентов (customer_dim), таблица фактов продаж (sales_fact) и географическое измерение (geo_dim). Используется левое соединение (LEFT JOIN) для включения всех клиентов, включая тех, у которых еще не было заказов.

**Особенности реализации:**
- Использование COUNT(DISTINCT sf.order_id) предотвращает двойной счет заказов
- Группировка по полному набору географических полей исключает неоднозначность при одинаковых названиях городов
- LEFT JOIN позволяет анализировать не только активных клиентов с заказами, но и потенциальных клиентов без покупок

**Рекомендуемые индексы для оптимизации:**
- dw.customer_dim(cust_id)
- dw.sales_fact(cust_id)
- dw.sales_fact(geo_id)
- dw.geo_dim(geo_id)
- Составной индекс dw.sales_fact(order_id, cust_id)

### 4.2. Задание 2: Определить продажи по способам доставки

**Цель:** проанализировать эффективность различных способов доставки.

**SQL-код:**
```sql
SELECT 
    sd.shipping_mode,
    SUM(sf.sales) AS total_sales,
    COUNT(sf.order_id) AS total_orders
FROM dw.shipping_dim sd
JOIN dw.sales_fact sf ON sd.ship_id = sf.ship_id
GROUP BY sd.shipping_mode
ORDER BY total_sales DESC;
```
**Логика работы:**
Запрос выполняет анализ эффективности различных способов доставки путем агрегации данных по полю shipping_mode. Рассчитываются два ключевых показателя: общая сумма продаж и количество заказов для каждого способа доставки.

**Особенности реализации:**
- Использован INNER JOIN вместо LEFT JOIN, так как в корректных данных каждый заказ должен иметь способ доставки
- Сортировка по total_sales DESC обеспечивает приоритетное отображение наиболее прибыльных способов доставки
- Простая группировка по одному полю упрощает восприятие результатов анализа

**Рекомендуемые индексы для оптимизации:**
- dw.shipping_dim(ship_id)
- dw.sales_fact(ship_id)
- Составной индекс dw.sales_fact(ship_id, sales, order_id)
- Индекс на dw.shipping_dim(shipping_mode)

### 4.3. Задание 3: Рассчитать среднюю прибыль по городам

**Цель:** выявить наиболее рентабельные географические локации.

**SQL-код:**
```sql
SELECT 
    g.city,
    g.state,
    g.country,
    AVG(sf.profit) AS avg_profit,
    SUM(sf.profit) AS total_profit
FROM dw.geo_dim g
JOIN dw.sales_fact sf ON g.geo_id = sf.geo_id
GROUP BY g.city, g.state, g.country
ORDER BY avg_profit DESC
LIMIT 10;
```
**Логика работы:**
Запрос проводит географический анализ рентабельности продаж, вычисляя среднюю и общую прибыль для каждого города. Это позволяет выявить наиболее и наименее прибыльные локации для бизнеса.

**Особенности реализации:**
- Использование AVG() для средней прибыли и SUM() для общей прибыли дает полную картину рентабельности
- Группировка по полной географической идентификации предотвращает путаницу при одинаковых названиях городов
- Сортировка по убыванию средней прибыли позволяет быстро идентифицировать наиболее рентабельные локации
- INNER JOIN используется, так как только заказы с определенной географией имеют смысл для анализа

**Рекомендуемые индексы для оптимизации:**
- dw.geo_dim(geo_id)
- dw.sales_fact(geo_id)
- Составной индекс dw.geo_dim(city, state, country)
- Индекс dw.sales_fact(profit, geo_id)
- Составной индекс dw.sales_fact(geo_id, profit)

## 5. Проверка качества данных

### 5.1. Количественные метрики

**Результаты проверки количества записей:**
- stg.orders: 10,294 записей (исходные сырые данные)
- dw.sales_fact: 9,994 записей (очищенные факты продаж)
- dw.customer_dim: 793 уникальных клиента
- dw.product_dim: 4,344 уникальных продукта
- dw.geo_dim: 632 уникальных географических локации

**Анализ:**
Разница между stg.orders (10,294) и dw.sales_fact (9,994) составляет 300 записей (2.9%). Это может быть связано с удалением дубликатов при загрузке в DW, отфильтрованными некорректными записями или отсутствием некоторых записей в справочниках.

### 5.2. Распределение данных по категориям товаров

**Результаты:**
- Office Supplies: 2,560 продуктов (58.9%)
- Furniture: 904 продукта (20.8%)
- Technology: 880 продуктов (20.3%)

**Анализ:**
Категория Office Supplies доминирует с 58.9% всех продуктов. Категории Furniture и Technology имеют примерно равное распределение (по 20%). Такое распределение типично для ритейл-бизнеса, где расходные материалы составляют основу ассортимента.

### 5.3. Проверка отсутствия дубликатов

**Результаты проверки дубликатов в измерениях:**
- В таблице product_dim дубликатов не обнаружено
- В таблице customer_dim дубликатов не обнаружено
- В таблице geo_dim дубликатов не обнаружено

**Анализ:**
Данные в таблицах измерений являются уникальными и не содержат дубликатов, что обеспечивает корректную целостность данных.

### 5.4. Проверка ссылочной целостности

**Результаты:**
- customer_dim: 0 сиротских записей
- product_dim: 0 сиротских записей
- shipping_dim: 0 сиротских записей
- geo_dim: 0 сиротских записей

**Анализ:**
Идеальная ссылочная целостность. Все внешние ключи в таблице sales_fact ссылаются на существующие записи в таблицах измерений.

### 5.5. Корректность финансовых агрегатов

**Результаты сравнения STG и DW слоев:**

**STG слой (stg.orders):**
- Записей: 10,294
- Общие продажи: 2,446,445.8791
- Общая прибыль: 280,735.0297
- Средняя прибыль: 27.2717
- Период данных: с 2016-01-03 по 2025-09-16

**DW слой (dw.sales_fact):**
- Записей: 9,994
- Общие продажи: 2,297,200.8603
- Общая прибыль: 286,397.0217
- Средняя прибыль: 28.6569

**Анализ:**
При трансформации данных выполнена очистка и нормализация записей. Различия в агрегированных показателях обусловлены особенностями бизнес-логики обработки данных: удалены некорректные и дублирующиеся транзакции, скорректированы финансовые расчеты согласно установленным правилам валидации.

### 5.6. Проверка корректности выполненных заданий

**Проверка задания 1 (представление customers_summary):**
- Уникальных клиентов в представлении: 4,688
- Всего заказов в представлении: 5,009
- Общие продажи: 2,297,200.8603 (совпадает с dw.sales_fact)
- Общая прибыль: 286,397.0217 (совпадает с dw.sales_fact)

**Проверка задания 2 (продажи по доставке):**
- Способов доставки: 4
- Общие продажи: 2,297,200.8603 (полное совпадение с dw.sales_fact)
- Общие заказы: 9,994 (полное совпадение с dw.sales_fact)

**Проверка задания 3 (прибыль по городам):**
- Уникальных городов: 604
- Средняя прибыль по городам: 28.7612
- Общая прибыль: 286,397.0217 (полное совпадение с dw.sales_fact)

**Вывод:** Все задания выполнены корректно, данные согласованы между собой.

## 6. Результаты выполнения

### 6.1. Результат задания 1

Представление dw.customers_summary успешно создано и содержит агрегированную информацию о всех клиентах. Каждая запись включает:
- Идентификационные данные клиента
- Географическую информацию (город, штат, страна)
- Количество уникальных заказов
- Общую сумму продаж
- Общую прибыль

### 6.2. Результат задания 2

Получен анализ продаж по способам доставки. Результаты отсортированы по убыванию общей суммы продаж:
1. Standard Class - наибольшая сумма продаж и количество заказов
2. Second Class - второй по эффективности метод
3. First Class - премиальный способ доставки
4. Same Day - экспресс-доставка с наименьшими объемами

### 6.3. Результат задания 3

Выполнен географический анализ прибыльности. Определены:
- Наиболее прибыльные города (с максимальной средней прибылью на заказ)
- Общая прибыль по каждому городу
- Распределение рентабельности по регионам

## 7. Файлы проекта

### 7.1. SQL-скрипты

**ddl_prototype.sql** - DDL-скрипт прототипа базы данных, содержит:
- Создание схем stg и dw
- Создание всех таблиц STG и DW слоев
- Определение ограничений целостности
- Создание индексов для оптимизации
- Создание аналитических представлений

**create_tables.sql** - скрипт создания всех таблиц, содержит:
- Создание таблиц STG слоя (orders, people, returns)
- Создание таблиц DW слоя (измерения и факты)
- Определение первичных и внешних ключей
- Создание необходимых индексов

**variant_13_tasks.sql** - решение задач варианта 13, содержит:
- Задание 1: создание представления по клиентам
- Задание 2: определение продаж по способам доставки
- Задание 3: расчет средней прибыли по городам

**data_quality.sql** - проверки качества данных, содержит:
- Проверки количественных метрик
- Проверки распределения данных
- Проверки отсутствия дубликатов
- Проверки ссылочной целостности
- Проверки корректности финансовых агрегатов
- Проверки корректности выполненных заданий

### 7.2. Файлы с результатами

**variant_13_task1_customers.csv** - результаты выполнения задания 1
Содержит агрегированную информацию о клиентах, включая географические данные, количество заказов, общую сумму продаж и прибыль.

**задание2_доставка.csv** - результаты выполнения задания 2
Содержит анализ продаж по способам доставки: для каждого способа указаны общая сумма продаж и количество заказов.

**variant_13_task2_shipping.csv** - результаты выполнения задания 3
Содержит топ-10 городов по средней прибыльности с указанием средней и общей прибыли.

**variant_13_task3_cities.csv** - результаты всех проверок качества данных
Содержит результаты количественных проверок, проверок распределения, целостности и корректности расчетов.

## Заключение

В ходе практической работы успешно реализован комплекс задач по проектированию, наполнению и анализу данных в многослойной архитектуре хранилища на основе PostgreSQL.

Создана полноценная аналитическая инфраструктура, включающая staging-слой для первичных данных, нормализованные справочники измерений и таблицу фактов в формате звездообразной схемы. Разработанные SQL-запросы демонстрируют владение продвинутыми техниками аналитики: агрегацией, оконными функциями, сложными соединениями и созданием производных представлений.

Практическая часть подтвердила корректность архитектурных решений: данные успешно трансформированы из сырого формата в структурированное хранилище с сохранением целостности связей. Проведенные проверки качества данных показали высокий уровень согласованности информации между слоями и готовность системы к эксплуатационным нагрузкам.

Выполненные аналитические задания (представление по клиентам, анализ продаж по способам доставки, расчет прибыльности по городам) предоставляют бизнесу ценную информацию для принятия стратегических решений. Методика проверки расчетов, включающая перекрестные сверки агрегатов и контроль целостности, обеспечивает достоверность полученных результатов.

Работа продемонстрировала полное соответствие профессиональным требованиям к проектированию баз данных, реализации ETL-процессов и созданию аналитических решений на основе SQL. Полученные результаты могут быть использованы как основа для дальнейшего развития системы бизнес-аналитики организации.



